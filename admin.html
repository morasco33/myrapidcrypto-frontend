<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | RapidCrypto</title>
  <link rel="stylesheet" href="dashboard.css" />
</head>
<body>
  <main>
    <h1>Admin Dashboard</h1>

    <section id="pendingUsers">
      <h2>Users Pending Approval</h2>
      <div id="userList">Loading...</div>
    </section>

    <section id="searchUser">
      <h2>Search & Manage User</h2>
      <input type="email" id="emailSearch" placeholder="Enter user email" />
      <button id="searchBtn">Search</button>
      <div id="searchResult"></div>
    </section>
  </main>

  <script>
    const ADMIN_AUTH_TOKEN = localStorage.getItem('admin_auth_token');
    const API_BASE = 'https://rapidcrypto-backend.onrender.com/api';

    async function fetchPendingUsers() {
      const userList = document.getElementById('userList');
      try {
        const res = await fetch(`${API_BASE}/admin/pending-users`, {
          headers: { Authorization: `Bearer ${ADMIN_AUTH_TOKEN}` }
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.message);

        if (data.users.length === 0) {
          userList.innerHTML = '<p>No users pending approval.</p>';
          return;
        }

        userList.innerHTML = '';
        data.users.forEach(user => {
          const div = document.createElement('div');
          div.className = 'user-item';
          div.innerHTML = `
            <p><strong>${user.username}</strong> (${user.email})</p>
            <button data-id="${user._id}" class="approve-btn">Approve</button>
          `;
          userList.appendChild(div);
        });

        document.querySelectorAll('.approve-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const userId = btn.dataset.id;
            try {
              const res = await fetch(`${API_BASE}/admin/approve-user/${userId}`, {
                method: 'POST',
                headers: { Authorization: `Bearer ${ADMIN_AUTH_TOKEN}` }
              });
              const result = await res.json();
              if (!res.ok || !result.success) throw new Error(result.message);
              alert('User approved.');
              fetchPendingUsers();
            } catch (err) {
              alert(`Error approving user: ${err.message}`);
            }
          });
        });

      } catch (err) {
        userList.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
      }
    }

    async function searchUserByEmail() {
      const email = document.getElementById('emailSearch').value.trim();
      const searchResult = document.getElementById('searchResult');
      if (!email) return alert("Enter a valid email");
      try {
        searchResult.innerHTML = 'Searching...';
        const res = await fetch(`${API_BASE}/admin/user-by-email?email=${encodeURIComponent(email)}`, {
          headers: { Authorization: `Bearer ${ADMIN_AUTH_TOKEN}` }
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.message);

        const user = data.user;
        searchResult.innerHTML = `
          <p><strong>${user.username}</strong> (${user.email})</p>
          <label>Balance: <input type="number" id="balanceInput" value="${user.balance}" /></label><br>
          <label>Assets (comma-separated): <input type="text" id="assetInput" placeholder="BTC:0.5, ETH:1.2" /></label><br>
          <button id="updateUserBtn">Update</button>
          <button id="resendVerification">Resend Verification</button>
        `;

        document.getElementById('updateUserBtn').addEventListener('click', async () => {
          const balance = parseFloat(document.getElementById('balanceInput').value);
          const assetStr = document.getElementById('assetInput').value.trim();
          const assets = assetStr.split(',').map(s => {
            const [symbol, amount] = s.trim().split(':');
            return { symbol: symbol.trim(), amount: parseFloat(amount.trim()) };
          });

          const res = await fetch(`${API_BASE}/admin/update-user/${user._id}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${ADMIN_AUTH_TOKEN}`
            },
            body: JSON.stringify({ balance, assets })
          });
          const result = await res.json();
          if (!res.ok || !result.success) throw new Error(result.message);
          alert("User updated.");
        });

        document.getElementById('resendVerification').addEventListener('click', async () => {
          const res = await fetch(`${API_BASE}/admin/resend-verification/${user._id}`, {
            method: 'POST',
            headers: { Authorization: `Bearer ${ADMIN_AUTH_TOKEN}` }
          });
          const result = await res.json();
          if (!res.ok || !result.success) throw new Error(result.message);
          alert("Verification email resent.");
        });

      } catch (err) {
        searchResult.innerHTML = `<p style="color:red;">${err.message}</p>`;
      }
    }

    document.getElementById('searchBtn').addEventListener('click', searchUserByEmail);
    fetchPendingUsers();
  </script>
</body>
</html>
