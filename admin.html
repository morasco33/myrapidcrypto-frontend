<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | RapidCrypto</title>
  <link rel="stylesheet" href="dashboard.css" />
  <style>
    .user-item { margin: 1em 0; padding: 1em; border: 1px solid #ccc; border-radius: 6px; }
    .edit-form input, .edit-form textarea { width: 100%; margin-top: 5px; margin-bottom: 10px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: #fff; padding: 2em; border-radius: 8px; width: 90%; max-width: 400px; }
  </style>
</head>
<body>
  <main>
    <h1>Admin Dashboard</h1>

    <section id="pendingUsers">
      <h2>Users Pending Approval</h2>
      <div id="userList">Loading...</div>
    </section>

    <section>
      <h2>All Users</h2>
      <button onclick="loadAllUsers()">Load All Users</button>
      <div id="allUsers"></div>
    </section>
  </main>

  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3>Edit User</h3>
      <form id="editForm">
        <label>Balance (USD): <input type="number" id="editBalance" /></label>
        <label>Assets (JSON: [{ symbol: "BTC", amount: 1.5 }]):
          <textarea id="editAssets" rows="4"></textarea>
        </label>
        <input type="hidden" id="editUserId" />
        <button type="submit">Save</button>
        <button type="button" onclick="closeEditModal()">Cancel</button>
      </form>
    </div>
  </div>

  <script>
    const ADMIN_AUTH_TOKEN = localStorage.getItem('admin_auth_token');
    const API_BASE = 'https://rapidcrypto-backend.onrender.com/api';

    async function fetchPendingUsers() {
      const userList = document.getElementById('userList');
      try {
        const res = await fetch(`${API_BASE}/admin/pending-users`, {
          headers: { Authorization: `Bearer ${ADMIN_AUTH_TOKEN}` }
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.message);

        if (data.users.length === 0) {
          userList.innerHTML = '<p>No users pending approval.</p>';
          return;
        }

        userList.innerHTML = '';
        data.users.forEach(user => {
          const div = document.createElement('div');
          div.className = 'user-item';
          div.innerHTML = `
            <p><strong>${user.username}</strong> (${user.email})</p>
            <button data-id="${user._id}" class="approve-btn">Approve</button>
          `;
          userList.appendChild(div);
        });

        document.querySelectorAll('.approve-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const userId = btn.dataset.id;
            try {
              const res = await fetch(`${API_BASE}/admin/approve-user/${userId}`, {
                method: 'POST',
                headers: { Authorization: `Bearer ${ADMIN_AUTH_TOKEN}` }
              });
              const result = await res.json();
              if (!res.ok || !result.success) throw new Error(result.message);
              alert('User approved.');
              fetchPendingUsers();
            } catch (err) {
              alert(`Error approving user: ${err.message}`);
            }
          });
        });

      } catch (err) {
        userList.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
      }
    }

    async function loadAllUsers() {
      const container = document.getElementById('allUsers');
      container.innerHTML = 'Loading...';
      try {
        const res = await fetch(`${API_BASE}/admin/all-users?page=1`, {
          headers: { Authorization: `Bearer ${ADMIN_AUTH_TOKEN}` }
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.message);

        container.innerHTML = '';
        data.users.forEach(user => {
          const div = document.createElement('div');
          div.className = 'user-item';
          div.innerHTML = `
            <p><strong>${user.username}</strong> (${user.email}) - Balance: $${user.balance}</p>
            <button onclick="openEditModal('${user._id}', ${user.balance}, '${JSON.stringify(user.assets || []).replace(/'/g, "&#39;").replace(/"/g, '&quot;')}')">Edit</button>
          `;
          container.appendChild(div);
        });
      } catch (err) {
        container.innerHTML = `<p style="color:red;">${err.message}</p>`;
      }
    }

    function openEditModal(id, balance, assetsJson) {
      document.getElementById('editUserId').value = id;
      document.getElementById('editBalance').value = balance;
      document.getElementById('editAssets').value = assetsJson.replace(/&quot;/g, '"');
      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editUserId').value;
      const balance = parseFloat(document.getElementById('editBalance').value);
      let assets;
      try {
        assets = JSON.parse(document.getElementById('editAssets').value);
      } catch (e) {
        alert('Invalid assets JSON'); return;
      }

      try {
        const res = await fetch(`${API_BASE}/admin/update-user`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${ADMIN_AUTH_TOKEN}`
          },
          body: JSON.stringify({ userId: id, balance, assets })
        });
        const result = await res.json();
        if (!res.ok || !result.success) throw new Error(result.message);
        alert('User updated successfully');
        closeEditModal();
        loadAllUsers();
      } catch (err) {
        alert(`Error updating user: ${err.message}`);
      }
    });

    fetchPendingUsers();
  </script>
</body>
</html>
