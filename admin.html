<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | RapidCrypto</title>
  <link rel="stylesheet" href="dashboard.css" />
  <style>
    .user-item { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
    .loading-text { color: gray; }
    .error-text { color: red; }
    .info-text { color: blue; }
    textarea { width: 100%; }
  </style>
</head>
<body>
  <main>
    <h1>Admin Dashboard</h1>

    <section id="pendingUsers">
      <h2>Users Pending Approval</h2>
      <div id="userList">Loading...</div>
    </section>

    <section id="allUsersSection">
      <h2>All Users</h2>
      <div id="allUsersList">Loading...</div>
      <div>
        <button id="prevPageBtn">Previous</button>
        <span id="currentPageSpan">Page: 1</span>
        <button id="nextPageBtn">Next</button>
      </div>
    </section>

    <section id="editUserModal" style="display:none;">
      <h3>Edit User</h3>
      <p id="editUserModalEmail"></p>
      <label for="editBalanceInput">Balance:</label>
      <input type="number" id="editBalanceInput" />
      <br />
      <label for="editAssetsInput">Assets (JSON format: [{"symbol":"BTC","amount":1.2}]):</label>
      <textarea id="editAssetsInput" rows="3"></textarea>
      <br />
      <button id="saveUserChangesBtn">Save</button>
      <button id="cancelUserEditBtn">Cancel</button>
      <p id="editUserModalMessage"></p>
    </section>
  </main>

  <script>
    const ADMIN_AUTH_TOKEN = localStorage.getItem('admin_auth_token');
    const API_BASE = 'https://rapidcrypto-backend.onrender.com/api';

    async function apiCall(endpoint, options = {}) {
      const res = await fetch(`${API_BASE}${endpoint}`, {
        ...options,
        headers: {
          ...(options.headers || {}),
          Authorization: `Bearer ${ADMIN_AUTH_TOKEN}`,
          'Content-Type': 'application/json'
        }
      });
      const data = await res.json();
      if (!res.ok || !data.success) throw new Error(data.message);
      return data;
    }

    async function fetchPendingUsers() {
      const userList = document.getElementById('userList');
      try {
        const data = await apiCall('/admin/pending-users');
        if (data.users.length === 0) {
          userList.innerHTML = '<p>No users pending approval.</p>';
          return;
        }

        userList.innerHTML = '';
        data.users.forEach(user => {
          const div = document.createElement('div');
          div.className = 'user-item';
          div.innerHTML = `
            <p><strong>${user.username}</strong> (${user.email})</p>
            <button data-id="${user._id}" class="approve-btn">Approve</button>
          `;
          userList.appendChild(div);
        });

        document.querySelectorAll('.approve-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const userId = btn.dataset.id;
            try {
              await apiCall(`/admin/approve-user/${userId}`, { method: 'POST' });
              alert('User approved.');
              fetchPendingUsers();
            } catch (err) {
              alert(`Error approving user: ${err.message}`);
            }
          });
        });

      } catch (err) {
        userList.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
      }
    }

    let currentPage = 1;
    async function fetchAllUsersPaginated(page = 1) {
      const allUsersList = document.getElementById('allUsersList');
      const pageSpan = document.getElementById('currentPageSpan');
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');

      allUsersList.innerHTML = '<p class="loading-text">Loading users...</p>';
      try {
        const data = await apiCall(`/admin/all-users?page=${page}`);
        allUsersList.innerHTML = '';
        data.users.forEach(user => {
          const div = document.createElement('div');
          div.className = 'user-item';
          div.innerHTML = `
            <p><strong>${user.username}</strong> (${user.email})</p>
            <p>Balance: $${user.balance?.toFixed(2) || '0.00'}</p>
            <p>Assets: ${user.assets?.map(a => `${a.symbol}:${a.amount}`).join(', ') || 'None'}</p>
            <button data-email="${user.email}" class="edit-btn">Edit</button>
          `;
          div.querySelector('.edit-btn').addEventListener('click', () => searchUserByEmail(user.email));
          allUsersList.appendChild(div);
        });

        pageSpan.textContent = `Page: ${page}`;
        currentPage = page;
        prevBtn.disabled = page === 1;
        nextBtn.disabled = !data.hasMore;
      } catch (e) {
        allUsersList.innerHTML = `<p class="error-text">Error loading users: ${e.message}</p>`;
      }
    }

    async function searchUserByEmail(email) {
      try {
        const data = await apiCall(`/admin/user-by-email?email=${encodeURIComponent(email)}`);
        openEditUserModal(data.user);
      } catch (err) {
        alert(`User not found: ${err.message}`);
      }
    }

    function openEditUserModal(user) {
      document.getElementById('editUserModalEmail').textContent = user.email;
      document.getElementById('editBalanceInput').value = user.balance || 0;
      document.getElementById('editAssetsInput').value = JSON.stringify(user.assets || [], null, 2);
      document.getElementById('editUserModal').style.display = 'block';
    }

    function closeEditUserModal() {
      document.getElementById('editUserModal').style.display = 'none';
      document.getElementById('editUserModalMessage').textContent = '';
    }

    async function handleSaveUserChanges() {
      const email = document.getElementById('editUserModalEmail').textContent;
      const newBalance = parseFloat(document.getElementById('editBalanceInput').value);
      const editUserModalMessage = document.getElementById('editUserModalMessage');

      let parsedAssets;
      try {
        parsedAssets = JSON.parse(document.getElementById('editAssetsInput').value);
        if (!Array.isArray(parsedAssets)) throw new Error('Assets must be an array');
      } catch (e) {
        editUserModalMessage.textContent = 'Error: Invalid assets format. Use valid JSON array.';
        editUserModalMessage.className = 'error-text';
        return;
      }

      try {
        await apiCall('/admin/update-user', {
          method: 'PUT',
          body: JSON.stringify({ email, balance: newBalance, assets: parsedAssets })
        });
        editUserModalMessage.textContent = 'Update successful!';
        editUserModalMessage.className = 'info-text';
        fetchAllUsersPaginated(currentPage);
        setTimeout(closeEditUserModal, 1200);
      } catch (err) {
        editUserModalMessage.textContent = `Error: ${err.message}`;
        editUserModalMessage.className = 'error-text';
      }
    }

    document.getElementById('cancelUserEditBtn').addEventListener('click', closeEditUserModal);
    document.getElementById('saveUserChangesBtn').addEventListener('click', handleSaveUserChanges);

    document.getElementById('prevPageBtn').addEventListener('click', () => {
      if (currentPage > 1) fetchAllUsersPaginated(currentPage - 1);
    });
    document.getElementById('nextPageBtn').addEventListener('click', () => {
      fetchAllUsersPaginated(currentPage + 1);
    });

    document.addEventListener('DOMContentLoaded', () => {
      fetchPendingUsers();
      fetchAllUsersPaginated();
    });
  </script>
</body>
</html>
